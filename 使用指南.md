# ANQ Scaff 使用指南

## 快速开始

### 前置要求

- Python >= 3.10
- uv（推荐）或 pip

### 安装 uv（如果还没有安装）

```bash
# Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# Linux/Mac
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### 1. 安装脚手架工具（源码安装）

> **重要**：本项目为源码项目，需要从源码安装。如果系统没有安装 pip，请使用 uv。

#### 使用 uv（推荐）

```bash
# 进入 anq_scaff 目录（注意：是包含 setup.py 的 anq_scaff 目录）
cd anq_scaff

# 安装脚手架工具（开发模式）
uv pip install -e .

# 验证安装
anq-scaff --help

# 如果验证失败，可以尝试重新安装
# uv pip uninstall anq-scaff
# uv pip install -e .

# 或直接使用（开发模式，无需安装）
uv run python -m anq_scaff.cli new myproject
```

#### 使用 pip（备选）

```bash
# 进入 anq_scaff 目录（注意：是包含 setup.py 的 anq_scaff 目录）
cd anq_scaff

# 安装脚手架工具（开发模式）
pip install -e .

# 验证安装
anq-scaff --help

# 如果验证失败，可以尝试重新安装
# pip uninstall anq-scaff
# pip install -e .

# 或直接使用（开发模式，无需安装）
python -m anq_scaff.cli new myproject
```

---

## 命令参考

### anq-scaff new - 创建新项目

创建一个完整的 FastAPI 项目结构。

#### 语法

```bash
anq-scaff new <项目名称> [选项]
```

#### 参数

| 参数           | 说明                                  | 默认值   |
| -------------- | ------------------------------------- | -------- |
| `project_name` | 项目名称（必需）                      | -        |
| `--db`         | 数据库类型：sqlite, mysql, postgresql | sqlite   |
| `--redis`      | 启用 Redis 缓存                       | 否       |
| `--celery`     | 启用 Celery 异步任务（暂未实现）      | 否       |
| `--output-dir` | 项目输出目录                          | 当前目录 |

#### 示例

```bash
# 基础项目（SQLite数据库）
anq-scaff new myproject

# 使用MySQL数据库
anq-scaff new myproject --db mysql

# 使用PostgreSQL数据库
anq-scaff new myproject --db postgresql

# 启用Redis缓存
anq-scaff new myproject --redis

# 组合使用
anq-scaff new myproject --db postgresql --redis

# 指定输出目录
anq-scaff new myproject --output-dir /path/to/projects
```

---

### anq-scaff add - 添加API模块

为现有项目添加新的 API 模块，自动生成完整的四层架构代码。

#### 语法

```bash
anq-scaff add <模块名称> [选项]
```

#### 参数

| 参数          | 说明                       | 默认值   |
| ------------- | -------------------------- | -------- |
| `module_name` | 模块名称（必需，小写字母） | -        |
| `--path`      | 项目路径                   | 当前目录 |
| `--version`   | API版本（v1, v2等）        | v1       |

#### 生成的文件

执行 `anq-scaff add user` 后会生成以下 4 个文件：

```
myproject/
├── app/
│   ├── api/
│   │   └── v1/
│   │       └── user.py          # API 路由层
│   ├── services/
│   │   └── user.py              # 业务逻辑层
│   ├── models/
│   │   └── user.py              # 数据模型层
│   └── schemas/
│       └── user.py              # 数据验证层
```

#### 完整使用示例

```bash
# 1. 进入项目目录
cd myproject

# 2. 添加 user 模块（默认 v1 版本）
anq-scaff add user

# 3. 添加 product 模块
anq-scaff add product

# 4. 添加 order 模块到 v2 版本
anq-scaff add order --version v2

# 5. 从其他目录添加模块（指定项目路径）
anq-scaff add category --path /path/to/myproject
```

#### 使用 uv 运行（推荐）

如果未安装脚手架工具，可以直接使用 `uv run`：

```bash
# 进入项目目录
cd myproject

# 添加模块
uv run python -m anq_scaff.cli add user

# 或者从 anq_scaff 父目录执行
cd /path/to/scaff
uv run python -m anq_scaff.cli add user --path myproject
```

#### 生成的代码说明

##### 1. API 路由层 (`app/api/v1/user.py`)

统一使用 `POST /{resource}/actions` 模式：

```python
@router.post("/user/actions")
async def unified_action(request: dict = Body(...)):
    """
    统一动作接口
    action: list, get, create, update, delete
    """
    action = request.get("action")
    params = request.get("params", {})
    # ...
```

##### 2. 业务逻辑层 (`app/services/user.py`)

包含完整的 CRUD 操作：

```python
class UserService:
    async def list(self, page, size, filters) -> Tuple[List, int]
    async def get(self, id) -> Optional[Dict]
    async def create(self, data) -> str
    async def update(self, id, data) -> bool
    async def delete(self, id) -> bool
```

##### 3. 数据模型层 (`app/models/user.py`)

SQLAlchemy ORM 模型：

```python
class User(Base):
    __tablename__ = "user"
    
    id = Column(String(32), primary_key=True)
    name = Column(String(100), nullable=False)
    description = Column(Text, nullable=True)
    status = Column(Integer, default=1)
    created_at = Column(DateTime)
    updated_at = Column(DateTime)
```

##### 4. 数据验证层 (`app/schemas/user.py`)

Pydantic 数据模式：

```python
class UserCreate(BaseModel):    # 创建请求
    name: str
    description: Optional[str]
    
class UserUpdate(BaseModel):    # 更新请求（字段可选）
    name: Optional[str]
    description: Optional[str]
    
class UserResponse(BaseModel):  # 响应模式
    id: str
    name: str
    created_at: datetime
```

#### 添加模块后的操作

1. **注册模型到 models/__init__.py（重要！）**

   编辑 `app/models/__init__.py`，导入新创建的模型：

   ```python
   from app.initializer._db import Base
   
   # 导入所有模型（确保它们注册到 Base.metadata）
   from app.models.user import User
   
   __all__ = ["Base", "User"]
   ```

   > **重要**：如果不导入模型，数据库表将不会被自动创建！

2. **修改数据模型字段**

   编辑 `app/models/user.py`，根据业务需求添加字段：

   ```python
   class User(Base):
       __tablename__ = "user"
       
       id = Column(String(32), primary_key=True)
       username = Column(String(50), unique=True, nullable=False)
       email = Column(String(100), unique=True, nullable=False)
       phone = Column(String(20), nullable=True)
       is_active = Column(Boolean, default=True)
       # ...
   ```

4. **同步修改 Schema**

   编辑 `app/schemas/user.py`，保持与模型一致：

   ```python
   class UserCreate(BaseModel):
       username: str = Field(..., min_length=3, max_length=50)
       email: str = Field(..., pattern=r'^[\w\.-]+@[\w\.-]+\.\w+$')
       phone: Optional[str] = None
   ```

5. **扩展业务逻辑**

   在 `app/services/user.py` 中添加业务方法：

   ```python
   class UserService:
       async def get_by_email(self, email: str) -> Optional[Dict]:
           async with g.db_async_session() as session:
               return await db_async_util.fetch_one(
                   session=session,
                   model=User,
                   filter_by={"email": email},
               )
   ```

6. **重启服务**

   ```bash
   # 删除旧数据库文件（如果需要重建表结构）
   del *.sqlite  # Windows
   rm *.sqlite   # Linux/Mac
   
   # 重启服务，表会自动创建
   uv run python runserver.py
   ```

---

## 项目启动

### 使用 uv（推荐）

```bash
cd myproject

# 创建虚拟环境（可选择 Python 版本）
uv venv                           # 使用默认 Python 版本
uv venv --python 3.12             # 指定 Python 3.12
uv venv --python 3.13             # 指定 Python 3.13

# 安装依赖
uv pip install -r requirements.txt

# 配置环境变量（创建 .env 文件）
cp .env.example .env
# 编辑 .env 文件设置数据库连接等

# 启动服务
uv run python runserver.py
```

### 使用 pip（备选）

```bash
cd myproject

# 创建虚拟环境
python -m venv .venv
# Windows
.venv\Scripts\activate
# Linux/Mac
source .venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量（创建 .env 文件）
cp .env.example .env
# 编辑 .env 文件设置数据库连接等

# 启动服务
python runserver.py
```

---

## 项目结构说明

生成的项目包含以下核心模块：

### app/api/
- **自动路由注册**: 所有在 `app/api/v1/` 下的 `.py` 文件，只要定义了 `router = APIRouter()`，就会自动注册
- **依赖注入**: `dependencies.py` 包含JWT和API Key认证
- **统一响应**: `responses.py` 提供统一的响应格式
- **异常处理**: `exceptions.py` 定义自定义异常

### app/services/
- **业务逻辑层**: 放置所有业务逻辑代码
- **服务类**: 每个模块一个服务类，封装 CRUD 和业务方法

### app/models/
- **数据模型**: SQLAlchemy ORM 模型定义
- **自动建表**: 启动时自动创建数据表

### app/schemas/
- **数据验证**: Pydantic 模式定义
- **请求/响应**: 分离创建、更新、响应模式

### app/initializer/
- **配置管理**: `_conf.py` 支持 .env 和环境变量
- **数据库初始化**: `_db.py` 支持同步和异步
- **日志初始化**: `_log.py` 使用loguru
- **缓存初始化**: `_cache.py` 支持内存和Redis缓存

### app/middleware/
- **CORS中间件**: 跨域请求处理
- **HTTP中间件**: 请求ID生成、异常捕获
- **异常处理**: 统一的异常响应格式

### app/cache/
- **缓存管理器**: 自动在内存和Redis之间切换
- **缓存装饰器**: `@cached` 装饰器自动缓存函数结果

---

## 核心功能使用

### 1. 统一路由接口

所有 CRUD 操作通过统一接口：

```python
# 列表查询
POST /user/actions
{
  "action": "list",
  "params": {"page": 1, "size": 10}
}

# 获取详情
POST /user/actions
{
  "action": "get",
  "params": {"id": "123456789"}
}

# 创建记录
POST /user/actions
{
  "action": "create",
  "params": {"name": "张三", "email": "zhangsan@example.com"}
}

# 更新记录
POST /user/actions
{
  "action": "update",
  "params": {"id": "123456789", "name": "李四"}
}

# 删除记录
POST /user/actions
{
  "action": "delete",
  "params": {"id": "123456789"}
}
```

### 2. 统一响应格式

```python
from app.api.responses import Responses
from app.api.status import Status

# 成功响应
return Responses.success(
    data={"id": 1, "name": "test"},
    msg="操作成功"
)
# 返回: {"code": 200, "msg": "操作成功", "data": {...}}

# 失败响应
return Responses.failure(
    status=Status.PARAMS_ERROR,
    msg="参数错误"
)
# 返回: {"code": 400, "msg": "参数错误", "data": null}
```

### 3. JWT认证

```python
from app.api.dependencies import get_current_user, JWTUser
from fastapi import Depends

@router.get("/user")
async def get_user(current_user: JWTUser = Depends(get_current_user)):
    return Responses.success(data={"user": current_user.dict()})
```

### 4. 缓存使用

```python
from app.initializer import g

# 直接使用缓存管理器
cache_manager = g.cache_manager

# 设置缓存
cache_manager.set("user:1", {"name": "test"}, expire=3600)

# 获取缓存
user = cache_manager.get("user:1")

# 使用装饰器
from app.cache import cached

@cached(expire=3600, key_prefix="user")
async def get_user(user_id: str):
    # 函数结果会自动缓存
    return user_data
```

### 5. 使用LoggingFastCRUD

```python
from app.utils.logging_fastcrud import LoggingFastCRUD
from app.models.user import User
from app.initializer import g

class UserService:
    def __init__(self):
        self.crud = LoggingFastCRUD(User)
    
    async def get_user(self, user_id: str):
        async with g.db_async_session() as session:
            return await self.crud.get(session, user_id)
```

### 6. 上下文感知日志

日志自动包含 `request_id` 和 `user_id`：

```python
from loguru import logger

logger.info("用户操作")  # 自动包含 request_id 和 user_id
```

### 7. 分层异常处理

```python
from app.api.exceptions_enterprise import BusinessException, ErrorCode

# 抛出业务异常
raise BusinessException(
    error_code=ErrorCode.RESOURCE_NOT_FOUND,
    message="用户不存在",
    details={"user_id": "123"}
)
```

### 8. 数据库操作

```python
from app.initializer import g
from app.models.user import User
from app.utils import db_async_util

async with g.db_async_session() as session:
    # 查询单条
    user = await db_async_util.fetch_one(
        session=session,
        model=User,
        filter_by={"id": user_id}
    )
    
    # 查询列表（分页）
    users, total = await db_async_util.fetch_all(
        session=session,
        model=User,
        page=1,
        size=10
    )
    
    # 创建
    user_id = await db_async_util.create(
        session=session,
        model=User,
        data={"name": "test", "phone": "13800138000"}
    )
    
    # 更新
    await db_async_util.update(
        session=session,
        model=User,
        data={"name": "new_name"},
        filter_by={"id": user_id}
    )
    
    # 删除
    await db_async_util.delete(
        session=session,
        model=User,
        filter_by={"id": user_id}
    )
```

---

## 配置说明

### 环境变量配置（推荐）

项目使用 pydantic-settings 和 `.env` 文件进行配置管理：

```bash
# .env 文件
APP_NAME=MyApp
APP_DEBUG=true
APP_ENV=dev

# 数据库配置
DB_ASYNC_URL=sqlite+aiosqlite:///./data.db
# DB_ASYNC_URL=postgresql+asyncpg://user:pass@localhost/db
# DB_ASYNC_URL=mysql+aiomysql://user:pass@localhost/db

# Redis配置（可选）
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT配置
JWT_SECRET_KEY=your-secret-key

# Snowflake ID 配置（可选）
SNOW_DATACENTER_ID=1
```

### 配置文件（可选）

如果使用YAML配置文件，位于 `config/` 目录：

- `app_dev.yaml`: 开发环境
- `app_test.yaml`: 测试环境
- `app_prod.yaml`: 生产环境

配置项说明：

```yaml
app_title: 应用标题
app_debug: true/false  # 调试模式
app_disable_docs: false  # 是否禁用API文档
db_url: 数据库连接URL（同步）
db_async_url: 数据库连接URL（异步）
redis_host: Redis主机
redis_port: Redis端口
```

---

## 开发建议

1. **API版本控制**: 使用 `app/api/v1/`, `app/api/v2/` 等目录进行版本管理
2. **模块化开发**: 每个业务模块包含 api、service、model、schema 四个文件
3. **统一路由接口**: 使用 `POST /<资源>/actions` 模式，保持接口规范统一
4. **错误处理**: 使用 `BusinessException` 和 `ErrorCode` 枚举定义业务错误
5. **日志记录**: 使用 `logger` 记录关键操作和异常，自动包含 request_id 和 user_id
6. **缓存策略**: 对频繁查询的数据使用缓存装饰器
7. **测试驱动**: 使用 pytest 编写测试，保证代码质量
8. **配置管理**: 使用 `.env` 文件管理配置，实现配置与代码分离

---

## 常见问题

### 安装相关问题

#### Q: 为什么需要从源码安装？

A: ANQ Scaff 目前是源码项目，尚未发布到 PyPI，因此需要从源码安装。

#### Q: 系统提示 `'pip' 不是内部或外部命令` 怎么办？

A: 这说明系统没有安装 pip。请使用 uv：

```bash
# 安装 uv
# Windows: powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
# Linux/Mac: curl -LsSf https://astral.sh/uv/install.sh | sh

# 使用 uv 安装
cd anq_scaff
uv pip install -e .
```

#### Q: 可以不安装直接使用吗？

A: 可以，使用以下命令（需要在 `anq_scaff` 目录下）：

```bash
# 使用 uv（推荐）
cd anq_scaff
uv run python -m anq_scaff.cli new myproject

# 使用 pip（如果已安装）
cd anq_scaff
python -m anq_scaff.cli new myproject
```

#### Q: 安装后报错 `ModuleNotFoundError: No module named 'anq_scaff'` 怎么办？

A: 请尝试以下解决方案：

1. **确保在正确的目录下安装**：
   ```bash
   # 必须在包含 setup.py 的 anq_scaff 目录下
   cd anq_scaff
   uv pip install -e .
   ```

2. **重新安装**：
   ```bash
   uv pip uninstall anq-scaff
   uv pip install -e .
   ```

3. **使用直接运行方式**（无需安装）：
   ```bash
   cd anq_scaff
   uv run python -m anq_scaff.cli new myproject
   ```

4. **检查 Python 环境**：
   ```bash
   # 确保在正确的虚拟环境中
   python -c "import sys; print(sys.executable)"
   ```

#### Q: 为什么使用 `-e` 参数？

A: `-e` 表示以"可编辑"模式安装，这样修改源码后无需重新安装即可生效，适合开发使用。

### 使用相关问题

#### Q: 如何添加新的API路由？

A: 有两种方式：

1. **使用脚手架命令**（推荐）：
   ```bash
   cd myproject
   anq-scaff add user
   ```

2. **手动创建**：在 `app/api/v1/` 目录下创建新的 `.py` 文件，定义 `router = APIRouter()`，路由会自动注册。

#### Q: `anq-scaff add` 命令生成的文件如何自定义？

A: 生成后请手动修改：

1. 编辑 `app/models/<module>.py` 添加业务字段
2. 编辑 `app/schemas/<module>.py` 更新数据验证
3. 编辑 `app/services/<module>.py` 扩展业务逻辑
4. 编辑 `app/api/v1/<module>.py` 添加自定义接口

#### Q: 如何修改响应格式？

A: 修改 `app/api/responses.py` 中的 `Responses` 类。

#### Q: 如何添加新的中间件？

A: 在 `app/middleware/` 目录下创建新的中间件文件，然后在 `app/middleware/__init__.py` 中注册。

#### Q: 缓存不生效？

A: 检查是否启用了Redis，以及 `g.cache_manager` 是否正确初始化。

---

## 测试

### 使用 uv（推荐）

```bash
# 运行所有测试
uv run pytest

# 运行特定测试
uv run pytest tests/test_user.py

# 查看覆盖率
uv run pytest --cov=app tests/
```

### 使用 pip（备选）

```bash
# 运行所有测试
pytest

# 运行特定测试
pytest tests/test_user.py

# 查看覆盖率
pytest --cov=app tests/
```

---

## 代码生成（Node.js 方式）

除了 `anq-scaff add` 命令，也可以使用内置的 Node.js 脚本快速生成代码：

```bash
# 安装 Node.js 依赖
npm install

# 运行代码生成器
npm run generate

# 或直接运行
node generate_code.js
```

---

## 下一步

- ✅ 统一路由接口
- ✅ 分层异常处理
- ✅ 上下文感知日志
- ✅ 异步CRUD抽象层
- ✅ 专业测试套件
- ✅ 灵活配置管理
- ✅ 应用生命周期管理
- ✅ 自动化代码生成
- 集成CI/CD
- 性能优化
- 安全加固
